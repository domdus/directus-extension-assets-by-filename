import{log as e,request as s}from"directus:api";const t=["items","users","roles","permissions","files","collections","relations","fields","settings","activity","revisions","presets","flows","operations","webhooks","dashboards","panels","translations","server","extensions","auth","graphql","static","folders","notifications","utils","schema","assets"];var n={id:process.env.ASSETS_FILENAME_ENDPOINT_PATH||"assets",handler:(n,{env:a,services:r,getSchema:o})=>{!function(e){if(!e)return;const s=e.toLowerCase().trim();if(t.includes(s))throw new Error(`The endpoint path "${e}" is reserved by Directus and cannot be used. Please choose a different value for ASSETS_FILENAME_ENDPOINT_PATH. Reserved endpoints: ${t.join(", ")}`)}(process.env.ASSETS_FILENAME_ENDPOINT_PATH);const i=process.env.ASSETS_FILENAME_ENDPOINT_PATH?"":"/_";async function c(t,n,i,c){if(!c||""===c.trim())return void n.sendStatus(404);const{FilesService:d}=r;try{const r=new d({schema:await o(),accountability:t.accountability}),f=await r.readByQuery({filter:{[i]:{_eq:c}},limit:1}),l=f?.[0];if(!l)return void n.sendStatus(404);await async function(t,n,r){let o="localhost",i="string"==typeof a.PORT?parseInt(a.PORT,10):a.PORT||8055;const c=`/assets/${t}${n.url?.includes("?")?n.url.substring(n.url.indexOf("?")):""}`,d=n.get("host");if(d){const[e,s]=d.split(":");o=e,s&&(i=parseInt(s,10))}else if(a.HOST){const[e,s]=a.HOST.split(":");o=e,s&&(i=parseInt(s,10))}const f=`${"localhost"===o||"127.0.0.1"===o?"http":"https"}://${o}:${i}${c}`,l={};for(const[e,s]of Object.entries(n.headers))"host"!==e.toLowerCase()&&void 0!==s&&(Array.isArray(s)?l[e]=s.join(", "):l[e]=String(s));try{const e=await s(f,{method:n.method||"GET",headers:l});if(r.statusCode=e.status||200,r.statusMessage=e.statusText||"OK",e.headers)for(const[s,t]of Object.entries(e.headers))void 0!==t&&"connection"!==s.toLowerCase()&&"transfer-encoding"!==s.toLowerCase()&&r.setHeader(s,String(t));e.data?Buffer.isBuffer(e.data)||"string"==typeof e.data?r.send(e.data):r.json(e.data):r.end()}catch(s){r.headersSent||(e(`Error proxying to assets endpoint: ${s instanceof Error?s.message:String(s)}`),r.status(500).json({errors:[{message:"Failed to proxy request to assets endpoint",extensions:{code:"INTERNAL_SERVER_ERROR"}}]}))}}(l.id,t,n)}catch(s){const t=s;if(403===t.status||403===t.statusCode)return void n.sendStatus(403);e(`Error in assets-by-${i} endpoint: ${s instanceof Error?s.message:String(s)}`),n.headersSent||n.sendStatus(404)}}process.env.ASSETS_FILENAME_ENDPOINT_PATH?n.get(`${i}/:filename`,(async(e,s)=>{const t=e.params.filename;await c(e,s,"filename_disk",t)})):n.get(`${i}/_/:filename`,(async(e,s)=>{const t=e.params.filename;await c(e,s,"filename_disk",t)}))}};export{n as default};
