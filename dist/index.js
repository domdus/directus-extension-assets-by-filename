import{request as e}from"http";var t={id:"assets",handler:(t,{env:s,services:a,getSchema:n})=>{async function i(t,i,o,r){if(!r||""===r.trim())return void i.sendStatus(404);const{FilesService:d}=a;try{const a=new d({schema:await n(),accountability:t.accountability}),l=await a.readByQuery({filter:{[o]:{_eq:r}},limit:1}),c=l?.[0];if(!c)return void i.sendStatus(404);!function(t,a,n){let i="localhost",o=s.PORT||8055,r=`/assets/${t}${a.url.includes("?")?a.url.substring(a.url.indexOf("?")):""}`;const d=a.get("host");if(d){const[e,t]=d.split(":");i=e,t&&(o=parseInt(t,10))}else if(s.HOST){const[e,t]=s.HOST.split(":");i=e,t&&(o=parseInt(t,10))}const l={...a.headers};delete l.host;const c=e({hostname:i,port:o,path:r,method:a.method,headers:l},(e=>{n.statusCode=e.statusCode,n.statusMessage=e.statusMessage;const t=e.headers;for(const[e,s]of Object.entries(t))"connection"!==e.toLowerCase()&&"transfer-encoding"!==e.toLowerCase()&&n.setHeader(e,s);e.pipe(n)}));c.on("error",(e=>{n.headersSent||n.status(500).json({errors:[{message:"Failed to proxy request to assets endpoint",extensions:{code:"INTERNAL_SERVER_ERROR"}}]})})),a.on("aborted",(()=>{c.destroy()})),c.end()}(c.id,t,i)}catch(e){if(403===e.status||403===e.statusCode)return void i.sendStatus(403);console.error(`Error in assets-by-${o} endpoint:`,e),i.headersSent||i.sendStatus(404)}}t.get("/field/filename_disk/:filename",(async(e,t)=>{const s=e.params.filename;await i(e,t,"filename_disk",s)})),t.get("/field/title/:filename",(async(e,t)=>{const s=e.params.filename;await i(e,t,"title",s)})),t.get("/field/filename_download/:filename",(async(e,t)=>{const s=e.params.filename;await i(e,t,"filename_download",s)})),t.get("/_/fd/:filename",(async(e,t)=>{const s=e.params.filename;await i(e,t,"filename_disk",s)})),t.get("/_/t/:filename",(async(e,t)=>{const s=e.params.filename;await i(e,t,"title",s)})),t.get("/_/d/:filename",(async(e,t)=>{const s=e.params.filename;await i(e,t,"filename_download",s)}))}};export{t as default};
