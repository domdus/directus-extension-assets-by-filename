const e=["items","users","roles","permissions","files","collections","relations","fields","settings","activity","revisions","presets","flows","operations","webhooks","dashboards","panels","translations","server","extensions","auth","graphql","static","folders","notifications","utils","schema","assets"];var s={id:process.env.ASSETS_FILENAME_ENDPOINT_PATH||"assetsf",handler:(s,{env:t,services:a,getSchema:n})=>{async function r(e,s,a){let n="localhost",r="string"==typeof t.PORT?parseInt(t.PORT,10):t.PORT||8055;const o=`/assets/${e}${s.url?.includes("?")?s.url.substring(s.url.indexOf("?")):""}`,i=s.get("host");if(i){const[e,s]=i.split(":");n=e,s&&(r=parseInt(s,10))}else if(t.HOST){const[e,s]=t.HOST.split(":");n=e,s&&(r=parseInt(s,10))}const c=`${"localhost"===n||"127.0.0.1"===n?"http":"https"}://${n}:${r}${o}`,d={};for(const[e,t]of Object.entries(s.headers))"host"!==e.toLowerCase()&&void 0!==t&&(Array.isArray(t)?d[e]=t.join(", "):d[e]=String(t));try{const e=await async function(e,s){const t=await fetch(e,{method:s?.method,headers:s?.headers||{}}),a=await t.arrayBuffer();return{status:t.status,statusText:t.statusText,headers:Object.fromEntries(t.headers.entries()),data:Buffer.from(a)}}(c,{method:s.method||"GET",headers:d});if(a.statusCode=e.status||200,a.statusMessage=e.statusText||"OK",e.headers)for(const[s,t]of Object.entries(e.headers))void 0!==t&&"connection"!==s.toLowerCase()&&"transfer-encoding"!==s.toLowerCase()&&a.setHeader(s,String(t));e.data?Buffer.isBuffer(e.data)||"string"==typeof e.data?a.send(e.data):a.json(e.data):a.end()}catch(e){a.headersSent||(console.log(`[directus-extension-assets-by-filename] Error proxying to assets endpoint: ${e instanceof Error?e.message:String(e)}`),a.status(500).json({errors:[{message:"Failed to proxy request to assets endpoint",extensions:{code:"INTERNAL_SERVER_ERROR"}}]}))}}!function(s){if(!s)return;const t=s.toLowerCase().trim();if(e.includes(t))throw new Error(`The endpoint path "${s}" is reserved by Directus and cannot be used. Please choose a different value for ASSETS_FILENAME_ENDPOINT_PATH. Reserved endpoints: ${e.join(", ")}`)}(process.env.ASSETS_FILENAME_ENDPOINT_PATH),s.get("/:filename",(async(e,s)=>{const t=e.params.filename;await async function(e,s,t,o){if(!o||""===o.trim())return void s.sendStatus(404);const{FilesService:i}=a;try{const a=new i({schema:await n(),accountability:e.accountability}),c=await a.readByQuery({filter:{[t]:{_eq:o}},limit:1}),d=c?.[0];if(!d)return void s.sendStatus(404);await r(d.id,e,s)}catch(e){const t=e;if(403===t.status||403===t.statusCode)return void s.sendStatus(403);console.log(`[directus-extension-assets-by-filename] Error in endpoint: ${e instanceof Error?e.message:String(e)}`),s.headersSent||s.sendStatus(404)}}(e,s,"filename_disk",t)}))}};export{s as default};
