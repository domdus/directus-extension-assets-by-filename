import{request as e}from"http";var t={id:process.env.ASSETS_FILENAME_ENDPOINT_PATH||"assets",handler:(t,{env:s,services:a,getSchema:n})=>{const o=process.env.ASSETS_FILENAME_ENDPOINT_PATH?"":"/_";async function i(t,o,i,r){if(!r||""===r.trim())return void o.sendStatus(404);const{FilesService:c}=a;try{const a=new c({schema:await n(),accountability:t.accountability}),d=await a.readByQuery({filter:{[i]:{_eq:r}},limit:1}),l=d?.[0];if(!l)return void o.sendStatus(404);!function(t,a,n){let o="localhost",i=s.PORT||8055,r=`/assets/${t}${a.url.includes("?")?a.url.substring(a.url.indexOf("?")):""}`;const c=a.get("host");if(c){const[e,t]=c.split(":");o=e,t&&(i=parseInt(t,10))}else if(s.HOST){const[e,t]=s.HOST.split(":");o=e,t&&(i=parseInt(t,10))}const d={...a.headers};delete d.host;const l=e({hostname:o,port:i,path:r,method:a.method,headers:d},(e=>{n.statusCode=e.statusCode,n.statusMessage=e.statusMessage;const t=e.headers;for(const[e,s]of Object.entries(t))"connection"!==e.toLowerCase()&&"transfer-encoding"!==e.toLowerCase()&&n.setHeader(e,s);e.pipe(n)}));l.on("error",(e=>{n.headersSent||n.status(500).json({errors:[{message:"Failed to proxy request to assets endpoint",extensions:{code:"INTERNAL_SERVER_ERROR"}}]})})),a.on("aborted",(()=>{l.destroy()})),l.end()}(l.id,t,o)}catch(e){if(403===e.status||403===e.statusCode)return void o.sendStatus(403);console.error(`Error in assets-by-${i} endpoint:`,e),o.headersSent||o.sendStatus(404)}}process.env.ASSETS_FILENAME_ENDPOINT_PATH?(t.get(`${o}/:filename`,(async(e,t)=>{const s=e.params.filename;await i(e,t,"filename_disk",s)})),t.get(`${o}/t/:filename`,(async(e,t)=>{const s=e.params.filename;await i(e,t,"title",s)})),t.get(`${o}/d/:filename`,(async(e,t)=>{const s=e.params.filename;await i(e,t,"filename_download",s)}))):(t.get(`${o}/fd/:filename`,(async(e,t)=>{const s=e.params.filename;await i(e,t,"filename_disk",s)})),t.get(`${o}/t/:filename`,(async(e,t)=>{const s=e.params.filename;await i(e,t,"title",s)})),t.get(`${o}/d/:filename`,(async(e,t)=>{const s=e.params.filename;await i(e,t,"filename_download",s)})))}};export{t as default};
