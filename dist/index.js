import{request as e}from"http";const s=["items","users","roles","permissions","files","collections","relations","fields","settings","activity","revisions","presets","flows","operations","webhooks","dashboards","panels","translations","server","extensions","auth","graphql","static","folders","notifications","utils","schema","assets"];var t={id:process.env.ASSETS_FILENAME_ENDPOINT_PATH||"assets",handler:(t,{env:a,services:n,getSchema:o})=>{!function(e){if(!e)return;const t=e.toLowerCase().trim();if(s.includes(t))throw new Error(`The endpoint path "${e}" is reserved by Directus and cannot be used. Please choose a different value for ASSETS_FILENAME_ENDPOINT_PATH. Reserved endpoints: ${s.join(", ")}`)}(process.env.ASSETS_FILENAME_ENDPOINT_PATH);const i=process.env.ASSETS_FILENAME_ENDPOINT_PATH?"":"/_";async function r(s,t,i,r){if(!r||""===r.trim())return void t.sendStatus(404);const{FilesService:c}=n;try{const n=new c({schema:await o(),accountability:s.accountability}),d=await n.readByQuery({filter:{[i]:{_eq:r}},limit:1}),l=d?.[0];if(!l)return void t.sendStatus(404);!function(s,t,n){let o="localhost",i=a.PORT||8055,r=`/assets/${s}${t.url.includes("?")?t.url.substring(t.url.indexOf("?")):""}`;const c=t.get("host");if(c){const[e,s]=c.split(":");o=e,s&&(i=parseInt(s,10))}else if(a.HOST){const[e,s]=a.HOST.split(":");o=e,s&&(i=parseInt(s,10))}const d={...t.headers};delete d.host;const l=e({hostname:o,port:i,path:r,method:t.method,headers:d},(e=>{n.statusCode=e.statusCode,n.statusMessage=e.statusMessage;const s=e.headers;for(const[e,t]of Object.entries(s))"connection"!==e.toLowerCase()&&"transfer-encoding"!==e.toLowerCase()&&n.setHeader(e,t);e.pipe(n)}));l.on("error",(e=>{n.headersSent||n.status(500).json({errors:[{message:"Failed to proxy request to assets endpoint",extensions:{code:"INTERNAL_SERVER_ERROR"}}]})})),t.on("aborted",(()=>{l.destroy()})),l.end()}(l.id,s,t)}catch(e){if(403===e.status||403===e.statusCode)return void t.sendStatus(403);console.error(`Error in assets-by-${i} endpoint:`,e),t.headersSent||t.sendStatus(404)}}process.env.ASSETS_FILENAME_ENDPOINT_PATH?(t.get(`${i}/:filename`,(async(e,s)=>{const t=e.params.filename;await r(e,s,"filename_disk",t)})),t.get(`${i}/t/:filename`,(async(e,s)=>{const t=e.params.filename;await r(e,s,"title",t)})),t.get(`${i}/d/:filename`,(async(e,s)=>{const t=e.params.filename;await r(e,s,"filename_download",t)}))):(t.get(`${i}/fd/:filename`,(async(e,s)=>{const t=e.params.filename;await r(e,s,"filename_disk",t)})),t.get(`${i}/t/:filename`,(async(e,s)=>{const t=e.params.filename;await r(e,s,"title",t)})),t.get(`${i}/d/:filename`,(async(e,s)=>{const t=e.params.filename;await r(e,s,"filename_download",t)})))}};export{t as default};
