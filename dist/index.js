import{request as e}from"http";var s=Object.defineProperty,t=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,r=(e,t,o)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const a=["items","users","roles","permissions","files","collections","relations","fields","settings","activity","revisions","presets","flows","operations","webhooks","dashboards","panels","translations","server","extensions","auth","graphql","static","folders","notifications","utils","schema","assets"];var i={id:process.env.ASSETS_FILENAME_ENDPOINT_PATH||"assets",handler:(s,{env:i,services:c,getSchema:l})=>{!function(e){if(!e)return;const s=e.toLowerCase().trim();if(a.includes(s))throw new Error(`The endpoint path "${e}" is reserved by Directus and cannot be used. Please choose a different value for ASSETS_FILENAME_ENDPOINT_PATH. Reserved endpoints: ${a.join(", ")}`)}(process.env.ASSETS_FILENAME_ENDPOINT_PATH);const d=process.env.ASSETS_FILENAME_ENDPOINT_PATH?"":"/_";function u(s,a,c){var l;let d="localhost",u="string"==typeof i.PORT?parseInt(i.PORT,10):i.PORT||8055;const p=`/assets/${s}${(null==(l=a.url)?void 0:l.includes("?"))?a.url.substring(a.url.indexOf("?")):""}`,f=a.get("host");if(f){const[e,s]=f.split(":");d=e,s&&(u=parseInt(s,10))}else if(i.HOST){const[e,s]=i.HOST.split(":");d=e,s&&(u=parseInt(s,10))}const h=((e,s)=>{for(var a in s||(s={}))o.call(s,a)&&r(e,a,s[a]);if(t)for(var a of t(s))n.call(s,a)&&r(e,a,s[a]);return e})({},a.headers);delete h.host;const E=e({hostname:d,port:u,path:p,method:a.method,headers:h},(e=>{c.statusCode=e.statusCode||200,c.statusMessage=e.statusMessage||"OK";const s=e.headers;for(const[e,t]of Object.entries(s))void 0!==t&&"connection"!==e.toLowerCase()&&"transfer-encoding"!==e.toLowerCase()&&c.setHeader(e,t);e.pipe(c)}));E.on("error",(e=>{c.headersSent||c.status(500).json({errors:[{message:"Failed to proxy request to assets endpoint",extensions:{code:"INTERNAL_SERVER_ERROR"}}]})})),a.on("aborted",(()=>{E.destroy()})),E.end()}async function p(e,s,t,o){if(!o||""===o.trim())return void s.sendStatus(404);const{FilesService:n}=c;try{const r=new n({schema:await l(),accountability:e.accountability}),a=await r.readByQuery({filter:{[t]:{_eq:o}},limit:1}),i=null==a?void 0:a[0];if(!i)return void s.sendStatus(404);u(i.id,e,s)}catch(e){const o=e;if(403===o.status||403===o.statusCode)return void s.sendStatus(403);console.error(`Error in assets-by-${t} endpoint:`,e),s.headersSent||s.sendStatus(404)}}process.env.ASSETS_FILENAME_ENDPOINT_PATH?s.get(`${d}/:filename`,(async(e,s)=>{const t=e.params.filename;await p(e,s,"filename_disk",t)})):s.get(`${d}/_/:filename`,(async(e,s)=>{const t=e.params.filename;await p(e,s,"filename_disk",t)}))}};export{i as default};
