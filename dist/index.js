import{request as e}from"http";const s=["items","users","roles","permissions","files","collections","relations","fields","settings","activity","revisions","presets","flows","operations","webhooks","dashboards","panels","translations","server","extensions","auth","graphql","static","folders","notifications","utils","schema","assets"];var t={id:process.env.ASSETS_FILENAME_ENDPOINT_PATH||"assets",handler:(t,{env:n,services:o,getSchema:a})=>{!function(e){if(!e)return;const t=e.toLowerCase().trim();if(s.includes(t))throw new Error(`The endpoint path "${e}" is reserved by Directus and cannot be used. Please choose a different value for ASSETS_FILENAME_ENDPOINT_PATH. Reserved endpoints: ${s.join(", ")}`)}(process.env.ASSETS_FILENAME_ENDPOINT_PATH);const r=process.env.ASSETS_FILENAME_ENDPOINT_PATH?"":"/_";async function i(s,t,r,i){if(!i||""===i.trim())return void t.sendStatus(404);const{FilesService:c}=o;try{const o=new c({schema:await a(),accountability:s.accountability}),d=await o.readByQuery({filter:{[r]:{_eq:i}},limit:1}),l=d?.[0];if(!l)return void t.sendStatus(404);!function(s,t,o){let a="localhost",r="string"==typeof n.PORT?parseInt(n.PORT,10):n.PORT||8055;const i=`/assets/${s}${t.url?.includes("?")?t.url.substring(t.url.indexOf("?")):""}`,c=t.get("host");if(c){const[e,s]=c.split(":");a=e,s&&(r=parseInt(s,10))}else if(n.HOST){const[e,s]=n.HOST.split(":");a=e,s&&(r=parseInt(s,10))}const d={...t.headers};delete d.host;const l=e({hostname:a,port:r,path:i,method:t.method,headers:d},(e=>{o.statusCode=e.statusCode||200,o.statusMessage=e.statusMessage||"OK";const s=e.headers;for(const[e,t]of Object.entries(s))void 0!==t&&"connection"!==e.toLowerCase()&&"transfer-encoding"!==e.toLowerCase()&&o.setHeader(e,t);e.pipe(o)}));l.on("error",(e=>{o.headersSent||o.status(500).json({errors:[{message:"Failed to proxy request to assets endpoint",extensions:{code:"INTERNAL_SERVER_ERROR"}}]})})),t.on("aborted",(()=>{l.destroy()})),l.end()}(l.id,s,t)}catch(e){const s=e;if(403===s.status||403===s.statusCode)return void t.sendStatus(403);console.error(`Error in assets-by-${r} endpoint:`,e),t.headersSent||t.sendStatus(404)}}process.env.ASSETS_FILENAME_ENDPOINT_PATH?t.get(`${r}/:filename`,(async(e,s)=>{const t=e.params.filename;await i(e,s,"filename_disk",t)})):t.get(`${r}/_/:filename`,(async(e,s)=>{const t=e.params.filename;await i(e,s,"filename_disk",t)}))}};export{t as default};
