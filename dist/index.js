import{request as e}from"http";var s=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,o=(e,t,a)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;const r=["items","users","roles","permissions","files","collections","relations","fields","settings","activity","revisions","presets","flows","operations","webhooks","dashboards","panels","translations","server","extensions","auth","graphql","static","folders","notifications","utils","schema","assets"];var i={id:process.env.ASSETS_FILENAME_ENDPOINT_PATH||"assets",handler:(s,{env:i,services:l,getSchema:c})=>{!function(e){if(!e)return;const s=e.toLowerCase().trim();if(r.includes(s))throw new Error(`The endpoint path "${e}" is reserved by Directus and cannot be used. Please choose a different value for ASSETS_FILENAME_ENDPOINT_PATH. Reserved endpoints: ${r.join(", ")}`)}(process.env.ASSETS_FILENAME_ENDPOINT_PATH);const d=process.env.ASSETS_FILENAME_ENDPOINT_PATH?"":"/_";function f(s,r,l){var c;let d="localhost",f="string"==typeof i.PORT?parseInt(i.PORT,10):i.PORT||8055;const p=`/assets/${s}${(null==(c=r.url)?void 0:c.includes("?"))?r.url.substring(r.url.indexOf("?")):""}`,u=r.get("host");if(u){const[e,s]=u.split(":");d=e,s&&(f=parseInt(s,10))}else if(i.HOST){const[e,s]=i.HOST.split(":");d=e,s&&(f=parseInt(s,10))}const m=((e,s)=>{for(var r in s||(s={}))a.call(s,r)&&o(e,r,s[r]);if(t)for(var r of t(s))n.call(s,r)&&o(e,r,s[r]);return e})({},r.headers);delete m.host;const h=e({hostname:d,port:f,path:p,method:r.method,headers:m},(e=>{l.statusCode=e.statusCode||200,l.statusMessage=e.statusMessage;const s=e.headers;for(const[e,t]of Object.entries(s))"connection"!==e.toLowerCase()&&"transfer-encoding"!==e.toLowerCase()&&l.setHeader(e,t);e.pipe(l)}));h.on("error",(e=>{l.headersSent||l.status(500).json({errors:[{message:"Failed to proxy request to assets endpoint",extensions:{code:"INTERNAL_SERVER_ERROR"}}]})})),r.on("aborted",(()=>{h.destroy()})),h.end()}async function p(e,s,t,a){if(!a||""===a.trim())return void s.sendStatus(404);const{FilesService:n}=l;try{const o=new n({schema:await c(),accountability:e.accountability}),r=await o.readByQuery({filter:{[t]:{_eq:a}},limit:1}),i=null==r?void 0:r[0];if(!i)return void s.sendStatus(404);f(i.id,e,s)}catch(e){const a=e;if(403===a.status||403===a.statusCode)return void s.sendStatus(403);console.error(`Error in assets-by-${t} endpoint:`,e),s.headersSent||s.sendStatus(404)}}process.env.ASSETS_FILENAME_ENDPOINT_PATH?(s.get(`${d}/:filename`,(async(e,s)=>{const t=e.params.filename;await p(e,s,"filename_disk",t)})),s.get(`${d}/t/:filename`,(async(e,s)=>{const t=e.params.filename;await p(e,s,"title",t)})),s.get(`${d}/d/:filename`,(async(e,s)=>{const t=e.params.filename;await p(e,s,"filename_download",t)}))):(s.get(`${d}/fd/:filename`,(async(e,s)=>{const t=e.params.filename;await p(e,s,"filename_disk",t)})),s.get(`${d}/t/:filename`,(async(e,s)=>{const t=e.params.filename;await p(e,s,"title",t)})),s.get(`${d}/d/:filename`,(async(e,s)=>{const t=e.params.filename;await p(e,s,"filename_download",t)})))}};export{i as default};
